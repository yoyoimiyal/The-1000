<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCII 摄像机</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        pre {
            font-family: 'Courier New', Courier, monospace;
            line-height: 0.6;
            /* Compress vertical space for better aspect ratio */
            font-size: 8px;
            /* Small font for resolution */
            white-space: pre;
            overflow: hidden;
        }

        canvas {
            display: none;
        }
    </style>
</head>

<body class="bg-black min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden text-green-500">

    <div class="fixed top-4 left-4 z-10">
        <h1 class="font-bold text-xl opacity-80">ASCII Camera</h1>
        <p class="text-xs opacity-50">Real-time Feed</p>
    </div>

    <!-- Output -->
    <pre id="ascii-output" class="select-none pointer-events-none"></pre>

    <!-- Controls -->
    <div
        class="fixed bottom-8 flex gap-4 bg-gray-900/80 backdrop-blur p-4 rounded-xl border border-green-900 z-10 items-center">
        <button onclick="toggleCam()" id="btn-cam"
            class="text-white text-xs font-bold uppercase hover:text-green-400">Start Camera</button>
        <div class="h-4 w-px bg-green-900"></div>
        <div class="flex items-center gap-2">
            <label class="text-[10px] text-green-700 uppercase font-bold">Contrast</label>
            <input type="range" id="contrast" min="0" max="255" value="128"
                class="w-20 h-1 bg-green-900 rounded appearance-none cursor-pointer accent-green-500">
        </div>
        <div class="h-4 w-px bg-green-900"></div>
        <button onclick="invert()" class="text-white text-xs font-bold uppercase hover:text-green-400">Invert</button>
        <a href="./navigation.html"
            class="text-green-700 hover:text-green-500 text-xs font-bold uppercase ml-2">Exit</a>
    </div>

    <video id="video" class="hidden" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const output = document.getElementById('ascii-output');
        const btnCam = document.getElementById('btn-cam');
        const contrastInput = document.getElementById('contrast');

        let isRunning = false;
        let animationId;
        let isInverted = false;

        // Character set from dark to light
        const density = "Ñ@#W$9876543210?!abc;:+=-,._                    ";
        // Width of ASCII render (characters)
        const renderWidth = 120;

        async function toggleCam() {
            if (isRunning) {
                stopCam();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } });
                    video.srcObject = stream;
                    isRunning = true;
                    btnCam.innerText = "Stop Camera";
                    btnCam.classList.add("text-red-500");
                    loop();
                } catch (e) {
                    alert("无法访问摄像头: " + e.message);
                }
            }
        }

        function stopCam() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            isRunning = false;
            cancelAnimationFrame(animationId);
            btnCam.innerText = "Start Camera";
            btnCam.classList.remove("text-red-500");
        }

        function invert() {
            isInverted = !isInverted;
        }

        function loop() {
            if (!isRunning) return;

            // Draw video frame to small canvas
            // Aspect ratio correction roughly 0.5 font aspect
            const w = renderWidth;
            const h = Math.floor(video.videoHeight / video.videoWidth * w * 0.55);

            canvas.width = w;
            canvas.height = h;

            // Mirror
            ctx.translate(w, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, w, h);
            ctx.setTransform(1, 0, 0, 1, 0, 0);

            const imageData = ctx.getImageData(0, 0, w, h);
            const data = imageData.data;

            let asciiStr = "";
            const contrastFactor = (259 * (parseInt(contrastInput.value) + 255)) / (255 * (259 - parseInt(contrastInput.value)));

            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const offset = (y * w + x) * 4;
                    let r = data[offset];
                    let g = data[offset + 1];
                    let b = data[offset + 2];

                    // Contrast
                    r = factorContrast(r, contrastFactor);
                    g = factorContrast(g, contrastFactor);
                    b = factorContrast(b, contrastFactor);

                    let avg = (r + g + b) / 3;
                    if (isInverted) avg = 255 - avg;

                    const len = density.length;
                    const charIndex = Math.floor((avg / 255) * len);

                    // Clamp
                    const idx = Math.max(0, Math.min(len - 1, len - 1 - charIndex));

                    asciiStr += density[idx];
                }
                asciiStr += "\n";
            }

            output.innerText = asciiStr;
            animationId = requestAnimationFrame(loop);
        }

        function factorContrast(val, factor) {
            return Math.min(255, Math.max(0, factor * (val - 128) + 128));
        }

    </script>
</body>

</html>