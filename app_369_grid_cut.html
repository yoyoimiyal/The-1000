<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>九宫格切图</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body class="bg-slate-100 min-h-screen flex flex-col items-center p-6 text-slate-800">

    <div class="w-full max-w-2xl">

        <header class="flex justify-between items-center mb-8">
            <h1 class="text-xl font-bold text-indigo-700 flex items-center gap-2">
                <span class="text-2xl">✂️</span> Grid Splitter
            </h1>
            <a href="./navigation.html" class="text-sm text-slate-400 hover:text-indigo-600">退出</a>
        </header>

        <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-200 text-center">

            <label
                class="block w-full h-48 border-2 border-dashed border-indigo-200 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-indigo-50 transition mb-8 bg-slate-50 relative overflow-hidden">
                <span class="text-indigo-500 font-bold mb-1">点击上传图片</span>
                <span class="text-xs text-slate-400">将自动裁剪为 3x3 九宫格</span>
                <input type="file" class="hidden" accept="image/*" onchange="handleFile(event)">
                <img id="preview"
                    class="absolute inset-0 w-full h-full object-contain hidden pointer-events-none bg-white opacity-50">
            </label>

            <!-- Grid Preview -->
            <div id="grid-result" class="grid grid-cols-3 gap-1 w-full max-w-[300px] mx-auto hidden mb-8 aspect-square">
                <!-- 9 Images injected here -->
            </div>

            <button onclick="downloadAll()" id="dl-btn"
                class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transition hidden disabled:opacity-50">
                下载 ZIP 压缩包
            </button>

        </div>

    </div>

    <!-- Hidden Canvas -->
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const gridRes = document.getElementById('grid-result');
        const dlBtn = document.getElementById('dl-btn');
        const preview = document.getElementById('preview');

        let blobs = [];

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            preview.src = url;
            preview.classList.remove('hidden');

            const img = new Image();
            img.onload = () => process(img);
            img.src = url;
        }

        function process(img) {
            blobs = [];
            gridRes.innerHTML = '';
            gridRes.classList.remove('hidden');
            dlBtn.classList.remove('hidden');
            dlBtn.innerText = "处理中...";
            dlBtn.disabled = true;

            // Determine crop size (Square based on smallest dimension)
            const minDim = Math.min(img.width, img.height);
            const size = minDim;
            const sx = (img.width - size) / 2;
            const sy = (img.height - size) / 2;

            // Each cell size
            const cellSize = size / 3;

            // Canvas size
            canvas.width = cellSize;
            canvas.height = cellSize;

            // Process 9 parts
            // Row-major order: 0,1,2 (top), 3,4,5 (mid), 6,7,8 (bot)

            let count = 0;
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 3; c++) {
                    ctx.clearRect(0, 0, cellSize, cellSize);

                    // Source coords
                    const x = sx + c * cellSize;
                    const y = sy + r * cellSize;

                    ctx.drawImage(img, x, y, cellSize, cellSize, 0, 0, cellSize, cellSize);

                    canvas.toBlob(blob => {
                        blobs.push({
                            name: `split_${r + 1}_${c + 1}.png`,
                            blob: blob,
                            index: r * 3 + c // to sort if async
                        });

                        // Show preview
                        const url = URL.createObjectURL(blob);
                        const imgEl = document.createElement('img');
                        imgEl.src = url;
                        imgEl.className = "w-full h-full object-cover block bg-gray-200";
                        // Order matters for grid append, but blob callback is async?
                        // Usually fast enough, but to be safe we can use placeholder array logic.
                        // For simplicity, just append. 
                        // Wait, append order might be wrong.
                        // Let's use a placeholder div.
                    }, 'image/png');

                    const div = document.createElement('div');
                    div.id = `cell-${r}-${c}`;
                    div.className = "aspect-square bg-gray-100 relative";
                    gridRes.appendChild(div);
                }
            }

            // Hacky wait for blobs
            setTimeout(() => {
                // Sort blobs by index
                blobs.sort((a, b) => a.index - b.index);

                // Populate preview
                blobs.forEach((item, i) => {
                    const r = Math.floor(i / 3);
                    const c = i % 3;
                    const container = document.getElementById(`cell-${r}-${c}`);
                    const imgEl = document.createElement('img');
                    imgEl.src = URL.createObjectURL(item.blob);
                    imgEl.className = "w-full h-full object-cover block";
                    container.appendChild(imgEl);
                });

                dlBtn.disabled = false;
                dlBtn.innerText = "下载 ZIP 压缩包";
            }, 500);
        }

        function downloadAll() {
            const zip = new JSZip();
            const folder = zip.folder("grid_images");

            blobs.forEach(item => {
                folder.file(item.name, item.blob);
            });

            zip.generateAsync({ type: "blob" }).then(function (content) {
                saveAs(content, "9-grid-images.zip");
            });
        }
    </script>
</body>

</html>