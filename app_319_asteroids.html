<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小行星 (Asteroids)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #000;
            overflow: hidden;
            touch-action: none;
        }

        canvas {
            display: block;
            border: 2px solid #333;
        }

        .controls-mobile {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 300px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            height: 60px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .btn:active {
            background: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center h-screen">

    <div class="absolute top-4 left-4 text-white font-mono pointer-events-none z-10">
        <h1 class="text-xl font-bold">ASTEROIDS</h1>
        <p>Score: <span id="score">0</span></p>
        <p class="text-xs text-gray-500">Arrows to Move, Space to Shoot</p>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="game-over"
        class="absolute inset-0 bg-black/80 hidden flex-col items-center justify-center z-20 text-white">
        <h2 class="text-4xl font-bold mb-4">GAME OVER</h2>
        <button onclick="startGame()"
            class="px-8 py-3 bg-white text-black font-bold rounded hover:bg-gray-200">RESTART</button>
        <a href="./navigation.html" class="mt-4 text-xs text-gray-500 hover:text-white">Exit</a>
    </div>

    <!-- Mobile Controls -->
    <div class="absolute bottom-4 z-10 controls-mobile md:hidden">
        <div class="btn" ontouchstart="keys.Left=true" ontouchend="keys.Left=false">◀</div>
        <div class="btn" ontouchstart="keys.Up=true" ontouchend="keys.Up=false">▲</div>
        <div class="btn" ontouchstart="keys.Right=true" ontouchend="keys.Right=false">▶</div>
        <div></div>
        <div class="btn bg-red-500/50" ontouchstart="shoot()" style="grid-column: span 1;">FIRE</div>
        <div></div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const gameOverEl = document.getElementById('game-over');

        let width, height;
        let ship;
        let asteroids = [];
        let bullets = [];
        let score = 0;
        let isPlaying = false;
        let animationId;

        const keys = { ArrowUp: false, ArrowLeft: false, ArrowRight: false, Space: false, Up: false, Left: false, Right: false };

        function resize() {
            width = canvas.width = window.innerWidth > 800 ? 800 : window.innerWidth;
            height = canvas.height = window.innerHeight > 600 ? 600 : window.innerHeight;
            if (ship) { ship.x = width / 2; ship.y = height / 2; }
        }
        window.addEventListener('resize', resize);

        class Ship {
            constructor() {
                this.x = width / 2;
                this.y = height / 2;
                this.a = 0; // Angle
                this.v = { x: 0, y: 0 };
                this.r = 10;
            }
            update() {
                if (keys.ArrowUp || keys.Up) {
                    this.v.x += Math.cos(this.a) * 0.1;
                    this.v.y += Math.sin(this.a) * 0.1;
                }
                if (keys.ArrowLeft || keys.Left) this.a -= 0.1;
                if (keys.ArrowRight || keys.Right) this.a += 0.1;

                this.x += this.v.x;
                this.y += this.v.y;

                // Friction
                this.v.x *= 0.99;
                this.v.y *= 0.99;

                // Wrap
                if (this.x < 0) this.x = width;
                if (this.x > width) this.x = 0;
                if (this.y < 0) this.y = height;
                if (this.y > height) this.y = 0;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.a);
                ctx.beginPath();
                ctx.moveTo(10, 0);
                ctx.lineTo(-10, 7);
                ctx.lineTo(-10, -7);
                ctx.closePath();
                ctx.strokeStyle = 'white';
                ctx.stroke();
                ctx.restore();
            }
        }

        class Bullet {
            constructor(x, y, a) {
                this.x = x;
                this.y = y;
                this.v = {
                    x: Math.cos(a) * 5,
                    y: Math.sin(a) * 5
                };
                this.life = 60;
            }
            update() {
                this.x += this.v.x;
                this.y += this.v.y;
                this.life--;

                if (this.x < 0) this.x = width;
                if (this.x > width) this.x = 0;
                if (this.y < 0) this.y = height;
                if (this.y > height) this.y = 0;
            }
            draw() {
                ctx.fillStyle = 'white';
                ctx.fillRect(this.x - 1, this.y - 1, 2, 2);
            }
        }

        class Asteroid {
            constructor(x, y, r) {
                this.x = x || Math.random() * width;
                this.y = y || Math.random() * height;
                // Don't spawn on ship
                if (!x && Math.hypot(this.x - ship.x, this.y - ship.y) < 100) {
                    this.x += 200;
                }

                this.r = r || 30;
                const angle = Math.random() * Math.PI * 2;
                const speed = (40 / this.r); // Smaller = faster
                this.v = {
                    x: Math.cos(angle) * speed,
                    y: Math.sin(angle) * speed
                };

                // Polygon shape
                this.verts = [];
                const sides = Math.floor(Math.random() * 5) + 7;
                for (let i = 0; i < sides; i++) {
                    this.verts.push((Math.random() * 0.4 + 0.8) * this.r);
                }
            }
            update() {
                this.x += this.v.x;
                this.y += this.v.y;

                if (this.x < -this.r) this.x = width + this.r;
                if (this.x > width + this.r) this.x = -this.r;
                if (this.y < -this.r) this.y = height + this.r;
                if (this.y > height + this.r) this.y = -this.r;
            }
            draw() {
                ctx.beginPath();
                const angleStep = (Math.PI * 2) / this.verts.length;
                for (let i = 0; i < this.verts.length; i++) {
                    const r = this.verts[i];
                    const angle = i * angleStep;
                    const x = Math.cos(angle) * r;
                    const y = Math.sin(angle) * r;
                    if (i === 0) ctx.moveTo(this.x + x, this.y + y);
                    else ctx.lineTo(this.x + x, this.y + y);
                }
                ctx.closePath();
                ctx.strokeStyle = '#9ca3af';
                ctx.stroke();
            }
        }

        function shoot() {
            if (!isPlaying) return;
            bullets.push(new Bullet(ship.x, ship.y, ship.a));
        }

        function startGame() {
            resize();
            ship = new Ship();
            asteroids = [];
            bullets = [];
            score = 0;
            scoreEl.innerText = 0;
            gameOverEl.classList.add('hidden');

            for (let i = 0; i < 5; i++) asteroids.push(new Asteroid());

            isPlaying = true;
            loop();
        }

        function loop() {
            if (!isPlaying) return;

            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, width, height);

            ship.update();
            ship.draw();

            for (let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i];
                b.update();
                b.draw();
                if (b.life <= 0) bullets.splice(i, 1);
            }

            for (let i = asteroids.length - 1; i >= 0; i--) {
                const a = asteroids[i];
                a.update();
                a.draw();

                // Ship collision
                if (Math.hypot(ship.x - a.x, ship.y - a.y) < ship.r + a.r) {
                    isPlaying = false;
                    gameOverEl.classList.remove('hidden');
                }

                // Bullet collision
                for (let j = bullets.length - 1; j >= 0; j--) {
                    const b = bullets[j];
                    if (Math.hypot(b.x - a.x, b.y - a.y) < a.r) {
                        // Hit
                        if (a.r > 15) {
                            // Split
                            asteroids.push(new Asteroid(a.x, a.y, a.r / 2));
                            asteroids.push(new Asteroid(a.x, a.y, a.r / 2));
                        }
                        asteroids.splice(i, 1);
                        bullets.splice(j, 1);
                        score += 100;
                        scoreEl.innerText = score;

                        // Spawn new if low
                        if (asteroids.length < 3) asteroids.push(new Asteroid());

                        break;
                    }
                }
            }

            animationId = requestAnimationFrame(loop);
        }

        document.addEventListener('keydown', e => {
            keys[e.code] = true;
            if (e.code === 'Space') shoot();
        });
        document.addEventListener('keyup', e => keys[e.code] = false);

        startGame();
    </script>
</body>

</html>