<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>康威生命游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        canvas {
            image-rendering: pixelated;
        }
    </style>
</head>

<body class="bg-gray-900 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-2xl">

        <header class="flex justify-between items-center mb-4 text-white">
            <h1 class="text-xl font-bold">Game of Life</h1>
            <div class="text-xs text-gray-400">Generation: <span id="gen-count" class="text-white font-mono">0</span>
            </div>
        </header>

        <canvas id="gameCanvas"
            class="bg-black w-full aspect-video border border-gray-700 shadow-xl mb-6 cursor-crosshair rounded"></canvas>

        <div class="flex flex-wrap gap-4 justify-center bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
            <button onclick="togglePlay()" id="play-btn"
                class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold min-w-[80px]">开始</button>
            <button onclick="step()"
                class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold">单步</button>
            <button onclick="randomize()"
                class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold">随机</button>
            <button onclick="clearGrid()"
                class="bg-red-900 hover:bg-red-800 text-red-200 px-4 py-2 rounded-lg font-bold">清空</button>
            <a href="./navigation.html"
                class="bg-gray-900 hover:bg-black text-gray-500 px-4 py-2 rounded-lg font-bold">退出</a>
        </div>

        <p class="text-center text-gray-500 text-xs mt-4">点击画布绘制细胞 · 规则: 2/3存活, 3繁殖</p>

    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const genEl = document.getElementById('gen-count');
        const playBtn = document.getElementById('play-btn');

        // Logic Grid size (smaller than canvas pixels for performance)
        const cols = 80;
        const rows = 45;
        const cellSize = 10; // Only for initial scale logic if needed, but we rely on canvas css size

        // Canvas Internal Resolution
        canvas.width = cols;
        canvas.height = rows;

        let grid = createGrid();
        let isPlaying = false;
        let generation = 0;
        let animationId;

        function createGrid() {
            return new Array(cols).fill(null).map(() => new Array(rows).fill(0));
        }

        function randomize() {
            for (let i = 0; i < cols; i++) {
                for (let j = 0; j < rows; j++) {
                    grid[i][j] = Math.random() > 0.85 ? 1 : 0;
                }
            }
            draw();
            generation = 0;
            genEl.innerText = 0;
        }

        function clearGrid() {
            grid = createGrid();
            draw();
            generation = 0;
            genEl.innerText = 0;
            if (isPlaying) togglePlay();
        }

        function draw() {
            // Clear
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, cols, rows);

            // Draw cells
            ctx.fillStyle = '#4ade80'; // green-400
            for (let i = 0; i < cols; i++) {
                for (let j = 0; j < rows; j++) {
                    if (grid[i][j] === 1) {
                        ctx.fillRect(i, j, 1, 1);
                    }
                }
            }
        }

        function computeNextGen() {
            const next = createGrid();
            for (let i = 0; i < cols; i++) {
                for (let j = 0; j < rows; j++) {
                    const state = grid[i][j];
                    const neighbors = countNeighbors(grid, i, j);

                    if (state === 0 && neighbors === 3) {
                        next[i][j] = 1;
                    } else if (state === 1 && (neighbors < 2 || neighbors > 3)) {
                        next[i][j] = 0;
                    } else {
                        next[i][j] = state;
                    }
                }
            }
            grid = next;
            generation++;
            genEl.innerText = generation;
        }

        function countNeighbors(grid, x, y) {
            let sum = 0;
            for (let i = -1; i < 2; i++) {
                for (let j = -1; j < 2; j++) {
                    const col = (x + i + cols) % cols;
                    const row = (y + j + rows) % rows;
                    sum += grid[col][row];
                }
            }
            sum -= grid[x][y];
            return sum;
        }

        function step() {
            computeNextGen();
            draw();
        }

        function loop() {
            if (isPlaying) {
                step();
                // Slow down slightly? setTimeout inside requestAnimationFrame or just let it rip
                // To make it watchable, we can throttle.
                setTimeout(() => requestAnimationFrame(loop), 50);
            }
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            playBtn.innerText = isPlaying ? "暂停" : "开始";
            playBtn.className = isPlaying
                ? "bg-yellow-600 hover:bg-yellow-500 text-white px-6 py-2 rounded-lg font-bold min-w-[80px]"
                : "bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold min-w-[80px]";

            if (isPlaying) loop();
        }

        // Interaction
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor(((e.clientX - rect.left) / rect.width) * cols);
            const y = Math.floor(((e.clientY - rect.top) / rect.height) * rows);

            if (x >= 0 && x < cols && y >= 0 && y < rows) {
                grid[x][y] = 1 - grid[x][y];
                draw();
            }
        });

        // Init
        randomize();
    </script>
</body>

</html>