<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专业节拍器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .beat-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #334155;
            transition: background-color 0.1s;
        }

        .beat-dot.active {
            background-color: #ef4444;
            box-shadow: 0 0 10px #ef4444;
            transform: scale(1.2);
        }

        .pendulum-container {
            width: 4px;
            height: 150px;
            background: #e2e8f0;
            margin: 0 auto;
            position: relative;
            transform-origin: top center;
        }

        .pendulum-weight {
            width: 30px;
            height: 40px;
            background: #64748b;
            border-radius: 4px;
            position: absolute;
            bottom: 0;
            left: -13px;
        }

        .swing-left {
            animation: swingLeft 0.5s ease-in-out infinite alternate;
        }

        @keyframes swingLeft {
            from {
                transform: rotate(30deg);
            }

            to {
                transform: rotate(-30deg);
            }
        }
    </style>
</head>

<body class="bg-slate-800 text-slate-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-slate-900 p-8 rounded-3xl shadow-2xl border border-slate-700">

        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold tracking-widest text-slate-400">METRONOME</h1>
            <a href="./navigation.html" class="text-xs text-slate-600 hover:text-white">EXIT</a>
        </div>

        <!-- BPM Display -->
        <div class="text-center mb-10">
            <div class="text-8xl font-bold text-white mb-2" id="bpm-display">120</div>
            <div class="text-sm text-slate-500 uppercase tracking-widest">BPM (Beats Per Minute)</div>
        </div>

        <!-- Slider -->
        <div class="mb-10 px-4">
            <input type="range" min="40" max="240" value="120" id="bpm-slider"
                class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                oninput="updateBPM(this.value)">
            <div class="flex justify-between mt-2 text-xs text-slate-500 font-mono">
                <span>40</span>
                <span>240</span>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex justify-center gap-6 mb-10 items-center">
            <button onclick="changeBPM(-1)"
                class="w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 text-xl font-bold">-</button>

            <button onclick="togglePlay()" id="play-btn"
                class="w-20 h-20 rounded-full bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg flex items-center justify-center transition transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>

            <button onclick="changeBPM(1)"
                class="w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 text-xl font-bold">+</button>
        </div>

        <!-- Visual Dots -->
        <div class="flex justify-center gap-4" id="dots-container">
            <div class="beat-dot"></div>
            <div class="beat-dot"></div>
            <div class="beat-dot"></div>
            <div class="beat-dot"></div>
        </div>

        <div class="mt-6 text-center">
            <select id="time-signature"
                class="bg-slate-800 border-none text-slate-400 text-sm py-1 px-3 rounded cursor-pointer outline-none"
                onchange="updateTimeSignature()">
                <option value="4">4/4 Time</option>
                <option value="3">3/4 Time</option>
                <option value="2">2/4 Time</option>
            </select>
        </div>

    </div>

    <script>
        let audioCtx;
        let isPlaying = false;
        let bpm = 120;
        let nextNoteTime = 0.0;
        let timerID = null;
        let lookahead = 25.0; // ms
        let scheduleAheadTime = 0.1; // sec
        let currentBeat = 0;
        let beatsPerBar = 4;

        const bpmDisplay = document.getElementById('bpm-display');
        const bpmSlider = document.getElementById('bpm-slider');
        const playBtn = document.getElementById('play-btn');
        const dotsContainer = document.getElementById('dots-container');

        function updateBPM(val) {
            bpm = parseInt(val);
            bpmDisplay.innerText = bpm;
            bpmSlider.value = bpm;
        }

        function changeBPM(delta) {
            let newVal = bpm + delta;
            if (newVal >= 40 && newVal <= 240) {
                updateBPM(newVal);
            }
        }

        function updateTimeSignature() {
            beatsPerBar = parseInt(document.getElementById('time-signature').value);
            // Re-render dots
            dotsContainer.innerHTML = '';
            for (let i = 0; i < beatsPerBar; i++) {
                const dot = document.createElement('div');
                dot.className = 'beat-dot';
                dotsContainer.appendChild(dot);
            }
        }

        function nextNote() {
            const secondsPerBeat = 60.0 / bpm;
            nextNoteTime += secondsPerBeat;
            currentBeat++;
            if (currentBeat >= beatsPerBar) {
                currentBeat = 0;
            }
        }

        function scheduleNote(beatNumber, time) {
            // Audio
            const osc = audioCtx.createOscillator();
            const envelope = audioCtx.createGain();

            osc.frequency.value = (beatNumber % beatsPerBar === 0) ? 1000 : 800;
            envelope.gain.value = 1;
            envelope.gain.exponentialRampToValueAtTime(1, time + 0.001);
            envelope.gain.exponentialRampToValueAtTime(0.001, time + 0.02);

            osc.connect(envelope);
            envelope.connect(audioCtx.destination);

            osc.start(time);
            osc.stop(time + 0.03);

            // Visual Sync (using standard setTimeout logic since UI doesn't need audio precision)
            // Draw visual a bit earlier or exactly at time?
            // Since `time` is in AudioContext time which might be ahead of real time, 
            // we calculate delay
            const visualDelay = (time - audioCtx.currentTime) * 1000;
            setTimeout(() => {
                visualizeBeat(beatNumber);
            }, Math.max(0, visualDelay));
        }

        function visualizeBeat(beat) {
            const dots = dotsContainer.children;
            for (let i = 0; i < dots.length; i++) {
                dots[i].className = 'beat-dot';
            }
            if (dots[beat]) {
                dots[beat].className = 'beat-dot active';
            }
        }

        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                scheduleNote(currentBeat, nextNoteTime);
                nextNote();
            }
            timerID = window.setTimeout(scheduler, lookahead);
        }

        function togglePlay() {
            if (isPlaying) {
                isPlaying = false;
                window.clearTimeout(timerID);
                playBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                playBtn.classList.remove('bg-red-500', 'hover:bg-red-400');
                playBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                return;
            }

            if (!audioCtx) {
                audioCtx = new AudioContext();
            }

            isPlaying = true;
            currentBeat = 0;
            nextNoteTime = audioCtx.currentTime + 0.05;
            scheduler();
            playBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            playBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
            playBtn.classList.add('bg-red-500', 'hover:bg-red-400');
        }

        // Init
        updateTimeSignature();
    </script>
</body>

</html>