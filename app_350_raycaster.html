<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>伪 3D 射线引擎</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0f0;
            font-family: monospace;
            z-index: 10;
            pointer-events: none;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 20;
        }

        .btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            user-select: none;
            border: 2px solid rgba(255, 255, 255, 0.4);
            touch-action: none;
        }

        .btn:active {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>

<body>

    <div class="ui">
        <h1>RAYCASTER</h1>
        <p>FPS: <span id="fps">0</span></p>
        <p class="text-xs opacity-50">WASD to Move</p>
    </div>

    <canvas id="canvas"></canvas>

    <div class="controls md:hidden">
        <div class="btn" ontouchstart="keys.a=true" ontouchend="keys.a=false">↺</div>
        <div class="btn" ontouchstart="keys.w=true" ontouchend="keys.w=false">↑</div>
        <div class="btn" ontouchstart="keys.s=true" ontouchend="keys.s=false">↓</div>
        <div class="btn" ontouchstart="keys.d=true" ontouchend="keys.d=false">↻</div>
    </div>

    <div class="absolute top-4 right-4 z-20">
        <a href="./navigation.html"
            class="text-white text-xs border border-white/30 px-3 py-1 rounded hover:bg-white/20">Exit</a>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const fpsEl = document.getElementById('fps');

        let width = window.innerWidth;
        let height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;

        window.addEventListener('resize', () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        });

        // Map
        const mapSize = 16;
        const map = [
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 2, 2, 0, 0, 0, 1,
            1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 1,
            1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 2, 2, 0, 0, 0, 3, 0, 3, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 3, 0, 3, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
        ];

        // Player
        let posX = 8.5, posY = 8.5;
        let dirX = -1, dirY = 0;
        let planeX = 0, planeY = 0.66; // FOV

        const keys = { w: false, s: false, a: false, d: false };

        let lastTime = 0;

        function loop(timestamp) {
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            fpsEl.innerText = Math.round(1 / dt);

            // Movement
            const moveSpeed = 5 * dt;
            const rotSpeed = 3 * dt;

            if (keys.w) {
                if (map[Math.floor(posX + dirX * moveSpeed) + Math.floor(posY) * mapSize] === 0) posX += dirX * moveSpeed;
                if (map[Math.floor(posX) + Math.floor(posY + dirY * moveSpeed) * mapSize] === 0) posY += dirY * moveSpeed;
            }
            if (keys.s) {
                if (map[Math.floor(posX - dirX * moveSpeed) + Math.floor(posY) * mapSize] === 0) posX -= dirX * moveSpeed;
                if (map[Math.floor(posX) + Math.floor(posY - dirY * moveSpeed) * mapSize] === 0) posY -= dirY * moveSpeed;
            }
            if (keys.d) {
                // Rotate Right
                const oldDirX = dirX;
                dirX = dirX * Math.cos(-rotSpeed) - dirY * Math.sin(-rotSpeed);
                dirY = oldDirX * Math.sin(-rotSpeed) + dirY * Math.cos(-rotSpeed);
                const oldPlaneX = planeX;
                planeX = planeX * Math.cos(-rotSpeed) - planeY * Math.sin(-rotSpeed);
                planeY = oldPlaneX * Math.sin(-rotSpeed) + planeY * Math.cos(-rotSpeed);
            }
            if (keys.a) {
                // Rotate Left
                const oldDirX = dirX;
                dirX = dirX * Math.cos(rotSpeed) - dirY * Math.sin(rotSpeed);
                dirY = oldDirX * Math.sin(rotSpeed) + dirY * Math.cos(rotSpeed);
                const oldPlaneX = planeX;
                planeX = planeX * Math.cos(rotSpeed) - planeY * Math.sin(rotSpeed);
                planeY = oldPlaneX * Math.sin(rotSpeed) + planeY * Math.cos(rotSpeed);
            }

            // Draw Background
            ctx.fillStyle = "#333"; // Ceiling
            ctx.fillRect(0, 0, width, height / 2);
            ctx.fillStyle = "#111"; // Floor
            ctx.fillRect(0, height / 2, width, height / 2);

            // Raycasting
            for (let x = 0; x < width; x++) {
                const cameraX = 2 * x / width - 1;
                const rayDirX = dirX + planeX * cameraX;
                const rayDirY = dirY + planeY * cameraX;

                let mapX = Math.floor(posX);
                let mapY = Math.floor(posY);

                let sideDistX, sideDistY;

                const deltaDistX = Math.abs(1 / rayDirX);
                const deltaDistY = Math.abs(1 / rayDirY);
                let perpWallDist;

                let stepX, stepY;
                let hit = 0;
                let side;

                if (rayDirX < 0) {
                    stepX = -1;
                    sideDistX = (posX - mapX) * deltaDistX;
                } else {
                    stepX = 1;
                    sideDistX = (mapX + 1.0 - posX) * deltaDistX;
                }
                if (rayDirY < 0) {
                    stepY = -1;
                    sideDistY = (posY - mapY) * deltaDistY;
                } else {
                    stepY = 1;
                    sideDistY = (mapY + 1.0 - posY) * deltaDistY;
                }

                // DDA
                while (hit === 0) {
                    if (sideDistX < sideDistY) {
                        sideDistX += deltaDistX;
                        mapX += stepX;
                        side = 0;
                    } else {
                        sideDistY += deltaDistY;
                        mapY += stepY;
                        side = 1;
                    }
                    if (map[mapX + mapY * mapSize] > 0) hit = 1;
                }

                if (side === 0) perpWallDist = (mapX - posX + (1 - stepX) / 2) / rayDirX;
                else perpWallDist = (mapY - posY + (1 - stepY) / 2) / rayDirY;

                const lineHeight = Math.floor(height / perpWallDist);
                const drawStart = -lineHeight / 2 + height / 2;
                // const drawEnd = lineHeight / 2 + height / 2;

                // Color
                const wallType = map[mapX + mapY * mapSize];
                let color = "#fff";
                if (wallType === 1) color = "#ef4444"; // Red
                else if (wallType === 2) color = "#3b82f6"; // Blue
                else if (wallType === 3) color = "#22c55e"; // Green

                // Shading
                if (side === 1) {
                    // Darker for Y-side
                    // Hex manipulation simplified: just re-assign darker color or use hsl
                    if (wallType === 1) color = "#991b1b";
                    else if (wallType === 2) color = "#1e3a8a";
                    else if (wallType === 3) color = "#14532d";
                }

                ctx.fillStyle = color;
                ctx.fillRect(x, drawStart, 1, lineHeight);
            }

            requestAnimationFrame(loop);
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'w' || e.key === 'ArrowUp') keys.w = true;
            if (e.key === 's' || e.key === 'ArrowDown') keys.s = true;
            if (e.key === 'a' || e.key === 'ArrowLeft') keys.a = true;
            if (e.key === 'd' || e.key === 'ArrowRight') keys.d = true;
        });

        document.addEventListener('keyup', e => {
            if (e.key === 'w' || e.key === 'ArrowUp') keys.w = false;
            if (e.key === 's' || e.key === 'ArrowDown') keys.s = false;
            if (e.key === 'a' || e.key === 'ArrowLeft') keys.a = false;
            if (e.key === 'd' || e.key === 'ArrowRight') keys.d = false;
        });

        requestAnimationFrame(loop);
    </script>
</body>

</html>