<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微习惯打卡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .heatmap-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background-color: #ebedf0;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .heatmap-cell:hover {
            transform: scale(1.4);
            z-index: 10;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .level-0 {
            background-color: #ebedf0;
        }

        .level-1 {
            background-color: #9be9a8;
        }

        .level-2 {
            background-color: #40c463;
        }

        .level-3 {
            background-color: #30a14e;
        }

        .level-4 {
            background-color: #216e39;
        }

        /* Custom Scrollbar for horizontal scrolling */
        .scroll-area::-webkit-scrollbar {
            height: 6px;
        }

        .scroll-area::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>

<body class="bg-white min-h-screen p-6 font-sans text-slate-800 flex flex-col items-center">

    <div class="w-full max-w-3xl">

        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold">Habit Tracker</h1>
                <p class="text-sm text-slate-400">每天进步一点点</p>
            </div>
            <div class="flex gap-2">
                <input type="text" id="habit-name"
                    class="border border-slate-200 rounded px-3 py-1 text-sm outline-none focus:border-green-500"
                    placeholder="习惯名称 (如: 读书)" onchange="saveName()">
                <a href="./navigation.html" class="text-sm text-slate-400 hover:text-green-600 px-2 py-1">退出</a>
            </div>
        </header>

        <!-- Stats -->
        <div class="flex gap-8 mb-6 text-sm">
            <div>
                <span class="block text-slate-400 text-xs uppercase">当前连续</span>
                <span class="font-bold text-xl" id="streak-curr">0</span> 天
            </div>
            <div>
                <span class="block text-slate-400 text-xs uppercase">最长连续</span>
                <span class="font-bold text-xl" id="streak-max">0</span> 天
            </div>
            <div>
                <span class="block text-slate-400 text-xs uppercase">总打卡</span>
                <span class="font-bold text-xl" id="total-days">0</span> 天
            </div>
        </div>

        <!-- Heatmap Scroll Wrapper -->
        <div class="overflow-x-auto scroll-area pb-4 mb-6 border border-slate-100 rounded-xl p-4 shadow-sm">
            <div class="flex gap-1" id="heatmap-container" style="min-width: 600px;">
                <!-- Grid injected by JS -->
                <!-- 53 columns (weeks), 7 rows (days) -->
            </div>
        </div>

        <div class="flex justify-between items-center text-xs text-slate-400">
            <div class="flex items-center gap-1">
                <span>Less</span>
                <div class="w-3 h-3 rounded-sm level-0"></div>
                <div class="w-3 h-3 rounded-sm level-1"></div>
                <div class="w-3 h-3 rounded-sm level-2"></div>
                <div class="w-3 h-3 rounded-sm level-3"></div>
                <div class="w-3 h-3 rounded-sm level-4"></div>
                <span>More</span>
            </div>
            <button onclick="resetData()" class="hover:text-red-500 transition">重置数据</button>
        </div>

    </div>

    <script>
        const container = document.getElementById('heatmap-container');
        const streakCurrEl = document.getElementById('streak-curr');
        const streakMaxEl = document.getElementById('streak-max');
        const totalEl = document.getElementById('total-days');
        const nameInput = document.getElementById('habit-name');

        // Data: Object keys 'YYYY-MM-DD', value 0-4
        let habitData = JSON.parse(localStorage.getItem('habit_data') || '{}');
        let habitName = localStorage.getItem('habit_name') || '阅读';
        nameInput.value = habitName;

        function saveName() {
            localStorage.setItem('habit_name', nameInput.value);
        }

        function toggleDay(dateStr) {
            const current = habitData[dateStr] || 0;
            // Cycle 0 -> 1 -> 2 -> 3 -> 4 -> 0
            const next = (current + 1) % 5;

            if (next === 0) delete habitData[dateStr];
            else habitData[dateStr] = next;

            saveData();
            renderHeatmap();
            updateStats();
        }

        function saveData() {
            localStorage.setItem('habit_data', JSON.stringify(habitData));
        }

        function resetData() {
            if (confirm("确定清空所有打卡记录吗？")) {
                habitData = {};
                saveData();
                renderHeatmap();
                updateStats();
            }
        }

        function renderHeatmap() {
            container.innerHTML = '';

            // Generate last 365 days
            const today = new Date();
            // Start from 52 weeks ago (approx) to align grid nicely?
            // GitHub graph usually starts ~1 year ago on the left.
            // Let's create 53 columns (weeks)

            const endDate = today;
            const startDate = new Date(endDate);
            startDate.setDate(endDate.getDate() - 364);

            // Adjust start date to be a Sunday/Monday? Let's assume standard Sunday start row 0
            // Simple approach: Column flex direction, then wrap? No, heatmaps are usually Col-based in HTML structure or Row based.
            // CSS Grid is easiest: 7 rows fixed, auto columns.
            container.style.display = 'grid';
            container.style.gridTemplateRows = 'repeat(7, 1fr)';
            container.style.gridAutoFlow = 'column';
            container.style.gap = '3px';

            for (let i = 0; i <= 364; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const level = habitData[dateStr] || 0;

                const cell = document.createElement('div');
                cell.className = `heatmap-cell level-${level}`;
                cell.title = `${dateStr}: ${level} 次`;
                cell.onclick = () => toggleDay(dateStr);

                container.appendChild(cell);
            }

            // Scroll to end
            const wrapper = document.querySelector('.scroll-area');
            wrapper.scrollLeft = wrapper.scrollWidth;
        }

        function updateStats() {
            // Calculate streaks
            const dates = Object.keys(habitData).sort();
            totalEl.innerText = dates.length;

            if (dates.length === 0) {
                streakCurrEl.innerText = 0;
                streakMaxEl.innerText = 0;
                return;
            }

            // Simple consecutive check (ignoring level intensity, just > 0)
            let maxStreak = 0;
            let currStreak = 0;
            let tempStreak = 0;

            // Convert to timestamps for day diff check
            const timeStamps = dates.map(d => new Date(d).getTime());
            const oneDay = 24 * 60 * 60 * 1000;

            // Check max streak
            // This logic needs to iterate all days in range to be accurate or just sort active days
            // If active days: 1, 2, 4. Streak 2.

            if (timeStamps.length > 0) {
                tempStreak = 1;
                maxStreak = 1;
                for (let i = 1; i < timeStamps.length; i++) {
                    const diff = Math.round((timeStamps[i] - timeStamps[i - 1]) / oneDay);
                    if (diff === 1) {
                        tempStreak++;
                    } else {
                        tempStreak = 1;
                    }
                    if (tempStreak > maxStreak) maxStreak = tempStreak;
                }
            }

            // Check current streak (counting back from today)
            // If today is active, or yesterday was active
            const todayStr = new Date().toISOString().split('T')[0];
            const yestStr = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            if (!habitData[todayStr] && !habitData[yestStr]) {
                currStreak = 0;
            } else {
                // Count backwards
                currStreak = 0;
                let d = new Date();
                // If today not marked, start from yesterday
                if (!habitData[d.toISOString().split('T')[0]]) {
                    d.setDate(d.getDate() - 1);
                }

                while (true) {
                    const s = d.toISOString().split('T')[0];
                    if (habitData[s]) {
                        currStreak++;
                        d.setDate(d.getDate() - 1);
                    } else {
                        break;
                    }
                }
            }

            streakMaxEl.innerText = maxStreak;
            streakCurrEl.innerText = currStreak;
        }

        renderHeatmap();
        updateStats();
    </script>
</body>

</html>