<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>流程图代码编辑器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col p-4 text-slate-800">

    <header class="flex justify-between items-center mb-4">
        <h1 class="text-xl font-bold flex items-center gap-2 text-indigo-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
            </svg>
            Mermaid Live
        </h1>
        <a href="./navigation.html" class="text-sm text-slate-400 hover:text-indigo-600">退出</a>
    </header>

    <div class="flex-1 flex flex-col md:flex-row gap-4 h-[85vh]">

        <!-- Editor -->
        <div class="w-full md:w-1/3 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200">
            <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-500 uppercase">Code</span>
                <div class="flex gap-2">
                    <button onclick="loadSample('flow')" class="text-xs text-indigo-500 hover:underline">Flow</button>
                    <button onclick="loadSample('sequence')"
                        class="text-xs text-indigo-500 hover:underline">Seq</button>
                    <button onclick="loadSample('gantt')" class="text-xs text-indigo-500 hover:underline">Gantt</button>
                </div>
            </div>
            <textarea id="input"
                class="flex-1 p-4 font-mono text-sm resize-none outline-none focus:ring-2 focus:ring-indigo-500"
                oninput="render()">
graph TD
    A[Start] --> B{Is it working?}
    B -- Yes --> C[Great!]
    B -- No --> D[Debug]
    D --> B
            </textarea>
        </div>

        <!-- Preview -->
        <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
            <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-500 uppercase">Preview</span>
                <button onclick="downloadSVG()"
                    class="text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 transition">下载
                    SVG</button>
            </div>
            <div class="flex-1 overflow-auto p-4 flex items-center justify-center bg-slate-50" id="preview-container">
                <div class="mermaid" id="graph-div">
                    graph TD
                    A[Start] --> B{Is it working?}
                    B -- Yes --> C[Great!]
                    B -- No --> D[Debug]
                    D --> B
                </div>
            </div>
            <div id="error-msg" class="bg-red-50 text-red-500 text-xs p-2 hidden border-t border-red-100"></div>
        </div>

    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });

        const input = document.getElementById('input');
        const container = document.getElementById('preview-container');
        const errorMsg = document.getElementById('error-msg');

        const samples = {
            flow: `graph TD\n    A[Start] --> B{Is it working?}\n    B -- Yes --> C[Great!]\n    B -- No --> D[Debug]\n    D --> B`,
            sequence: `sequenceDiagram\n    Alice->>John: Hello John, how are you?\n    John-->>Alice: Great!\n    Alice-)John: See you later!`,
            gantt: `gantt\n    title A Gantt Diagram\n    dateFormat  YYYY-MM-DD\n    section Section\n    A task           :a1, 2026-01-01, 30d\n    Another task     :after a1  , 20d`
        };

        function loadSample(type) {
            input.value = samples[type];
            render();
        }

        async function render() {
            const code = input.value;
            errorMsg.classList.add('hidden');

            try {
                // Mermaid render API is async in v10+? Or sync?
                // Using modern API: mermaid.render(id, text)
                const { svg } = await mermaid.render('graph-div-render', code);
                container.innerHTML = svg;
            } catch (e) {
                // Mermaid throws errors sometimes, we catch visual error
                errorMsg.innerText = e.message;
                errorMsg.classList.remove('hidden');
                // Don't clear old graph to avoid flicker while typing valid code parts? 
                // Actually mermaid clears it on error usually.
            }
        }

        function downloadSVG() {
            const svgData = container.innerHTML;
            const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "diagram.svg";
            link.click();
        }

        // Init handled by mermaid auto load for first render, then manual
        // But we want to hook input immediately.
        // Re-render initial content cleanly
        setTimeout(() => render(), 500); 
    </script>
</body>

</html>