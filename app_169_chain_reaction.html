<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËøûÈîÅÂèçÂ∫î</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        canvas {
            touch-action: none;
            cursor: crosshair;
        }
    </style>
</head>

<body class="bg-black h-screen w-screen overflow-hidden flex flex-col">

    <!-- Header Overlay -->
    <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-center text-white pointer-events-none z-10">
        <div>
            <h1 class="font-bold text-xl text-emerald-400">Chain Reaction</h1>
            <p class="text-sm opacity-70">Popped: <span id="score">0</span> / <span id="total">50</span></p>
        </div>
        <a href="./navigation.html"
            class="pointer-events-auto bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded text-xs font-bold transition">EXIT</a>
    </div>

    <!-- Start Overlay -->
    <div id="overlay" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-20">
        <h2 class="text-4xl font-bold text-white mb-2" id="msg-title">Ready?</h2>
        <p class="text-gray-400 mb-8 text-sm" id="msg-sub">ÁÇπÂáªÂ±èÂπïÂºïÂèëÁàÜÁÇ∏ÔºåÂ∞ΩÂèØËÉΩÂ§öÂú∞ÂºïÁàÜÂ∞èÁêÉ</p>
        <button onclick="startGame()"
            class="px-8 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-full shadow-lg transition transform hover:scale-105">
            ÂºÄÂßã (Level 1)
        </button>
    </div>

    <canvas id="gameCanvas" class="w-full h-full block bg-black"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const totalEl = document.getElementById('total');
        const overlay = document.getElementById('overlay');
        const titleEl = document.getElementById('msg-title');
        const subEl = document.getElementById('msg-sub');

        let width, height;
        let balls = [];
        let explosions = []; // static expanding circles
        let isPlaying = false;
        let hasTriggered = false;
        let score = 0;
        let totalBalls = 50;
        let animationId;

        // Settings
        const ballRadius = 4;
        const explosionMaxRadius = 40;
        const explosionSpeed = 0.5; // expansion rate
        const speed = 2; // ball speed

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        class Ball {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                const angle = Math.random() * Math.PI * 2;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.color = `hsl(${Math.random() * 360}, 70%, 60%)`;
                this.active = true;
            }
            update() {
                if (!this.active) return;
                this.x += this.vx;
                this.y += this.vy;

                // Bounce
                if (this.x < 0 || this.x > width) this.vx *= -1;
                if (this.y < 0 || this.y > height) this.vy *= -1;
            }
            draw() {
                if (!this.active) return;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, ballRadius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        class Explosion {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.radius = 1;
                this.color = color; // transparent fill?
                this.alpha = 0.6;
                this.growing = true;
            }
            update() {
                if (this.growing) {
                    this.radius += explosionSpeed;
                    if (this.radius >= explosionMaxRadius) this.growing = false;
                } else {
                    // Shrink or fade? Let's just fade
                    this.alpha -= 0.005; // Fade speed
                }
            }
            draw() {
                if (this.alpha <= 0) return;
                ctx.fillStyle = this.color; // Should use rgba
                ctx.globalAlpha = this.alpha;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        function startGame() {
            balls = [];
            explosions = [];
            score = 0;
            hasTriggered = false;
            isPlaying = true;
            scoreEl.innerText = 0;
            totalEl.innerText = totalBalls;
            overlay.style.display = 'none';

            for (let i = 0; i < totalBalls; i++) balls.push(new Ball());

            loop();
        }

        function trigger(x, y) {
            if (hasTriggered) return;
            hasTriggered = true;
            explosions.push(new Explosion(x, y, 'rgba(255,255,255,0.8)'));
        }

        function gameOver() {
            isPlaying = false;
            cancelAnimationFrame(animationId);
            const ratio = score / totalBalls;

            if (ratio > 0.5) {
                titleEl.innerText = "Success! üéâ";
                titleEl.className = "text-4xl font-bold text-green-500 mb-2";
            } else {
                titleEl.innerText = "Failed üò¢";
                titleEl.className = "text-4xl font-bold text-red-500 mb-2";
            }

            subEl.innerText = `Score: ${score}/${totalBalls}. Try to get >50%`;
            overlay.style.display = 'flex';
        }

        function loop() {
            if (!isPlaying) return;

            ctx.clearRect(0, 0, width, height);

            // Update Balls
            let activeBalls = 0;
            balls.forEach(b => {
                b.update();
                b.draw();
                if (b.active) activeBalls++;
            });

            // Update Explosions
            for (let i = explosions.length - 1; i >= 0; i--) {
                const e = explosions[i];
                e.update();
                e.draw();

                // Collision check
                balls.forEach(b => {
                    if (b.active) {
                        const dx = b.x - e.x;
                        const dy = b.y - e.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < e.radius + ballRadius) {
                            // Chain Reaction!
                            b.active = false;
                            score++;
                            scoreEl.innerText = score;
                            explosions.push(new Explosion(b.x, b.y, b.color)); // New explosion at ball pos
                        }
                    }
                });

                if (e.alpha <= 0) explosions.splice(i, 1);
            }

            // Check End Condition
            // End when triggered AND no explosions left
            if (hasTriggered && explosions.length === 0) {
                setTimeout(gameOver, 500); // Slight delay
                return;
            }

            animationId = requestAnimationFrame(loop);
        }

        // Input
        window.addEventListener('mousedown', e => trigger(e.clientX, e.clientY));
        window.addEventListener('touchstart', e => {
            e.preventDefault();
            trigger(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });

    </script>
</body>

</html>